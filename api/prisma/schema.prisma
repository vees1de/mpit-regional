generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  vkId      String   @unique
  fullName  String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leaderboardEntries LeaderboardEntry[]
  reactions          GameReaction[]
}

model Game {
  id          Int      @id @default(autoincrement())
  slug        String   @unique
  title       String
  description String?
  coverUrl    String?
  entryUrl    String
  maxMoves    Int?
  gameType    GameType?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leaderboardEntries LeaderboardEntry[]
  reactions          GameReaction[]
  scores             GameScore[]
}

model LeaderboardEntry {
  id        Int      @id @default(autoincrement())
  position  Int
  score     Int
  createdAt DateTime @default(now())

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int

  game   Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  gameId Int

  @@unique([gameId, userId])
  @@index([gameId, position])
}

model GameReaction {
  id        Int           @id @default(autoincrement())
  type      ReactionType
  createdAt DateTime      @default(now())

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int

  game   Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  gameId Int

  @@unique([userId, gameId])
}

model GameScore {
  id         Int      @id @default(autoincrement())
  score      Int
  movesUsed  Int?
  maxMoves   Int?
  completed  Boolean  @default(false)
  metadata   Json?
  createdAt  DateTime @default(now())

  // user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int

  game   Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  gameId Int

  @@index([gameId, score])
  @@index([userId, createdAt])
}

enum ReactionType {
  LIKE
  DISLIKE
}

enum GameType {
  MATCH3
  GAME2048
}
